sequential_plant_watering:
  alias: Sequential Plant Watering
  mode: single
  sequence:
    # 1. Acquire the lock
    - condition: state
      entity_id: lock.sequential_watering
      state: "unlocked"
      
    - service: lock.lock
      target:
        entity_id: lock.sequential_watering

    # --- Plant 1 Logic ---
    - if:
        - condition: numeric_state
          entity_id: sensor.plant_1_moisture
          below: input_number.plant_1_min_moisture
      then:
        - service: notify.persistent_notification
          data:
            message: "Starting watering for Plant 1."
        - service: switch.turn_on
          target:
            entity_id: switch.plant_1_solenoid_valve
        - delay: 
            seconds: "{{ states('input_number.plant_1_water_duration') | int }}"
        - service: switch.turn_off
          target:
            entity_id: switch.plant_1_solenoid_valve
        - delay: "00:00:05"

    # --- Plant 2 Logic ---
    - if:
        - condition: numeric_state
          entity_id: sensor.plant_2_moisture
          below: input_number.plant_2_min_moisture
      then:
        - service: notify.persistent_notification
          data:
            message: "Starting watering for Plant 2."
        - service: switch.turn_on
          target:
            entity_id: switch.plant_2_solenoid_valve
        - delay: 
            seconds: "{{ states('input_number.plant_2_water_duration') | int }}"
        - service: switch.turn_off
          target:
            entity_id: switch.plant_2_solenoid_valve
        - delay: "00:00:05"

    # --- Plant 3 Logic ---
    - if:
        - condition: numeric_state
          entity_id: sensor.plant_3_moisture
          below: input_number.plant_3_min_moisture
      then:
        - service: notify.persistent_notification
          data:
            message: "Starting watering for Plant 3."
        - service: switch.turn_on
          target:
            entity_id: switch.plant_3_solenoid_valve
        - delay: 
            seconds: "{{ states('input_number.plant_3_water_duration') | int }}"
        - service: switch.turn_off
          target:
            entity_id: switch.plant_3_solenoid_valve
        - delay: "00:00:05"

    # 4. Release the lock
    - service: lock.unlock
      target:
        entity_id: lock.sequential_watering
