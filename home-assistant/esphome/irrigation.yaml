esphome:
  name: irrigation-controller
  friendly_name: Irrigation Controller
  on_boot:
    priority: 600
    then:
      # Check if we should stay awake for OTA updates
      - if:
          condition:
            switch.is_on: prevent_deep_sleep
          then:
            - deep_sleep.prevent: deep_sleep_1
      # Otherwise, take a reading immediately on boot
      - script.execute: read_sensors

esp32:
  board: esp32-c3-devkitm-1
  framework:
    type: esp-idf

# Deep Sleep Configuration
deep_sleep:
  id: deep_sleep_1
  run_duration: 60s
  sleep_duration: 14min # Sleep for 14 mins, run for 1 min = 15 min cycle

# Enable logging
logger:

# Enable Home Assistant API
api:
  password: ""

ota:
  password: ""

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Irrigation-Controller-Fallback"
    password: ""

captive_portal:

# --- GPIO Configuration ---
# Plant 1: Power: 5, ADC: 0 (GPIO 0), Valve: 6
# Plant 2: Power: 7, ADC: 1 (GPIO 1), Valve: 10
# Plant 3: Power: 3, ADC: 4 (GPIO 4), Valve: 20
# LED: 8 (Active Low)

# Status LED
status_led:
  pin:
    number: 8
    inverted: true

# --- Switches for Valves ---
switch:
  - platform: template
    name: "Prevent Deep Sleep"
    id: prevent_deep_sleep
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF

  - platform: gpio
    pin: 
      number: 6
      inverted: true # Active Low
    name: "Plant 1 Solenoid Valve"
    id: plant_1_valve
    on_turn_on:
      - deep_sleep.prevent: deep_sleep_1
    on_turn_off:
      - deep_sleep.allow: deep_sleep_1

  - platform: gpio
    pin: 
      number: 10
      inverted: true # Active Low
    name: "Plant 2 Solenoid Valve"
    id: plant_2_valve
    on_turn_on:
      - deep_sleep.prevent: deep_sleep_1
    on_turn_off:
      - deep_sleep.allow: deep_sleep_1

  - platform: gpio
    pin: 
      number: 20
      inverted: true # Active Low
    name: "Plant 3 Solenoid Valve"
    id: plant_3_valve
    on_turn_on:
      - deep_sleep.prevent: deep_sleep_1
    on_turn_off:
      - deep_sleep.allow: deep_sleep_1

  # Internal switches for sensor power
  - platform: gpio
    pin: 5
    id: plant_1_power
    internal: true
  
  - platform: gpio
    pin: 7
    id: plant_2_power
    internal: true

  - platform: gpio
    pin: 3
    id: plant_3_power
    internal: true

# --- Sensors ---
sensor:
  - platform: adc
    pin: 0
    id: plant_1_adc
    name: "Plant 1 Moisture"
    update_interval: never # Updated by script
    attenuation: 11db

  - platform: adc
    pin: 1
    id: plant_2_adc
    name: "Plant 2 Moisture"
    update_interval: never # Updated by script
    attenuation: 11db

  - platform: adc
    pin: 4
    id: plant_3_adc
    name: "Plant 3 Moisture"
    update_interval: never # Updated by script
    attenuation: 11db

# --- Script to Read Sensors ---
script:
  - id: read_sensors
    then:
      # Plant 1
      - switch.turn_on: plant_1_power
      - delay: 100ms
      - component.update: plant_1_adc
      - switch.turn_off: plant_1_power
      - delay: 1s

      # Plant 2
      - switch.turn_on: plant_2_power
      - delay: 100ms
      - component.update: plant_2_adc
      - switch.turn_off: plant_2_power
      - delay: 1s

      # Plant 3
      - switch.turn_on: plant_3_power
      - delay: 100ms
      - component.update: plant_3_adc
      - switch.turn_off: plant_3_power

# Expose a button to force update from HA
button:
  - platform: template
    name: "Update Moisture Readings"
    on_press:
      then:
        - script.execute: read_sensors
